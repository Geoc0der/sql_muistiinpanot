--Testifunktio, jossa valitaan intersectaavat polygonit
Select he_vakiy from rttk250m_2023 join testi_polygon_2 on ST_Intersects(rttk250m_2023.geom,testi_polygon_2.geom);

--Kuinka löytää taulukon epsg-numero
select find_srid('public','ruudukko_suomi','geom');

--Kuinka lasketaan taulun viivamuotoisten geometrioiden pituudet
ALTER TABLE melontareitti_toka ADD COLUMN pituuskm REAL;
UPDATE melontareitti_toka
SET pituuskm = ST_LENGTH(geom) / 1000;

--Kuinka luoda pistemuotoinen taulu
create table kosket (id serial, name varchar, geom geometry(Point, 3067));

-- Parametrit: ruudun koko (meters), alueen rajat
DO $$
DECLARE
    grid_size NUMERIC := 1000; -- Ruudun koko metreinä
    xmin NUMERIC := 200000;
    ymin NUMERIC := 6700000;
    xmax NUMERIC := 300000;
    ymax NUMERIC := 6800000;
    x NUMERIC;
    y NUMERIC;
BEGIN
    -- Luodaan ruudukon taulu, jos sitä ei ole olemassa
    CREATE TABLE IF NOT EXISTS grid (
        id SERIAL PRIMARY KEY,
        geom GEOMETRY(POLYGON, 3067) -- Muuta SRID tarpeen mukaan
    );
    
    -- Poistetaan vanhat ruudut
    DELETE FROM grid;
    
    -- Luodaan ruudut
    x := xmin;
    WHILE x < xmax LOOP
        y := ymin;
        WHILE y < ymax LOOP
            INSERT INTO grid (geom)
            VALUES (
                ST_SetSRID(
                    ST_MakePolygon(ST_MakeLine(ARRAY[
                        ST_MakePoint(x, y),
                        ST_MakePoint(x + grid_size, y),
                        ST_MakePoint(x + grid_size, y + grid_size),
                        ST_MakePoint(x, y + grid_size),
                        ST_MakePoint(x, y)
                    ])),
                    3067 -- Muuta tarvittaessa SRID
                )
            );
            
            y := y + grid_size;
        END LOOP;
        x := x + grid_size;
    END LOOP;
END $$;
